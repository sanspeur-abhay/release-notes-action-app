name: Generate Release Notes

on:
  push:
    tags:
      - 'v*' # Trigger on version tags

jobs:
  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Required for creating releases
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch all history for generating release notes
      
      - name: Get tag name
        id: get_tag
        run: |
          echo "tag=${GITHUB_REF#refs/tags/}" >> "$GITHUB_OUTPUT"

      - name: Get previous tag
        id: prev_tag
        run: |
          git fetch --tags
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo '')
          echo "tag=$PREV_TAG" >> "$GITHUB_OUTPUT"
      
      - name: Generate release notes
        run: |
          if [ -n "${{ steps.prev_tag.outputs.tag }}" ]; then
            echo "## What's Changed" > RELEASE_NOTES.md
            echo "" >> RELEASE_NOTES.md
            
            # Features
            echo "### ✨ Features" >> RELEASE_NOTES.md
            git log --pretty=format:"* %s" ${{ steps.prev_tag.outputs.tag }}..${{ steps.get_tag.outputs.tag }} | grep -i "^* feat" >> RELEASE_NOTES.md || true
            echo "" >> RELEASE_NOTES.md
            echo "" >> RELEASE_NOTES.md
            
            # Bug Fixes
            echo "### 🐛 Bug Fixes" >> RELEASE_NOTES.md
            git log --pretty=format:"* %s" ${{ steps.prev_tag.outputs.tag }}..${{ steps.get_tag.outputs.tag }} | grep -i "^* fix" >> RELEASE_NOTES.md || true
            echo "" >> RELEASE_NOTES.md
            echo "" >> RELEASE_NOTES.md
            
            # Other Changes
            echo "### 🔄 Other Changes" >> RELEASE_NOTES.md
            git log --pretty=format:"* %s" ${{ steps.prev_tag.outputs.tag }}..${{ steps.get_tag.outputs.tag }} | grep -iv "^* feat\|^* fix" >> RELEASE_NOTES.md || true
          else
            echo "## 🎉 Initial Release" > RELEASE_NOTES.md
            echo "" >> RELEASE_NOTES.md
            git log --pretty=format:"* %s" ${{ steps.get_tag.outputs.tag }} >> RELEASE_NOTES.md
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_tag.outputs.tag }}
          name: Release ${{ steps.get_tag.outputs.tag }}
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 